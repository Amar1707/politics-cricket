<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Card Game - Lok Sabha Elections 2024</title>
    <style>
        :root {
            --primary-color: #f47216;
            --secondary-color: #2b5797;
            --accent-color: #00a550;
            --light-bg: #f5f5f5;
            --dark-bg: #333;
            --text-color: #333;
            --light-text: #fff;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.2);
            --border-radius: 10px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }
        
        header h1 {
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .game-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        button {
            background-color: var(--secondary-color);
            color: var(--light-text);
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #1e3c6b;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .reset-btn {
            background-color: #d9534f;
        }
        
        .reset-btn:hover {
            background-color: #c9302c;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .scoreboard {
            background-color: var(--secondary-color);
            color: var(--light-text);
            padding: 20px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .score-section {
            flex: 1;
            min-width: 200px;
            text-align: center;
        }
        
        .scoreboard h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .score-detail {
            font-size: 1.2rem;
            margin: 5px 0;
        }
        
        .current-innings {
            font-weight: bold;
            background-color: var(--accent-color);
            color: var(--light-text);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .match-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            text-align: center;
            min-width: 120px;
        }
        
        .stat-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary-color);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .board {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        
        .play-area {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .card-played {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .card-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .card {
            position: relative;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            height: auto;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: var(--light-text);
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .card-body {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            max-height: 350px;
        }
        
        .card-info {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .info-value {
            text-align: right;
        }
        
        .party-tag {
            background-color: var(--secondary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .action-area {
            margin-top: 30px;
        }
        
        .card-selection {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .player-cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .player-card {
            width: 180px;
            height: 280px;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .player-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .mini-card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mini-player-image {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .mini-card-body {
            padding: 8px;
            font-size: 0.75rem;
            flex: 1;
            overflow-y: auto;
        }
        
        .mini-card-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .mini-info-label {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .mini-card-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .mini-info-label {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .game-log {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            box-shadow: var(--card-shadow);
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--secondary-color);
            text-align: center;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .log-highlight {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .hidden {
            display: none;
        }
        
        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .modal-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .modal-message {
            font-size: 1.2rem;
            margin-bottom: 25px;
        }
        
        .modal-button {
            background-color: var(--accent-color);
            padding: 12px 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                height: auto;
                min-height: 450px;
            }
            
            .player-card {
                width: 150px;
                height: 300px;
                font-size: 0.7rem;
            }
            
            .mini-card-body {
                font-size: 0.7rem;
            }
            
            .play-area {
                gap: 15px;
            }
        }

        .result-highlight {
            font-size: 1.5rem;
            color: var(--accent-color);
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .ball-result {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .wicket {
            color: #d9534f;
        }

        .runs {
            color: var(--accent-color);
        }
        
        /* New styles for outcome area and next ball button */
        .outcome-area {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px auto;
            box-shadow: var(--card-shadow);
            text-align: center;
            max-width: 600px;
        }
        
        .outcome-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .outcome-message {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .next-ball-btn {
            background-color: var(--accent-color);
            margin-top: 15px;
            font-size: 1.1rem;
        }
        
        .next-ball-btn:hover {
            background-color: #008c45;
        }
        
        /* Card refresh styles */
        .refresh-info {
            background-color: var(--secondary-color);
            color: var(--light-text);
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: inline-block;
        }
        
        .card-refresh-highlight {
            background-color: rgba(0, 165, 80, 0.1);
            border: 2px solid var(--accent-color);
            transform: translateY(-3px);
        }
        
        .discard-btn {
            background-color: #d9534f;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .card-count {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .final-scoreboard {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
        }
        
        .final-score-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--secondary-color);
            text-align: center;
        }
        
        .final-score-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .final-score-label {
            font-weight: bold;
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cricket Card Game - Lok Sabha Elections 2024</h1>
            <p>Use election candidate cards to play cricket!</p>
        </header>
        <!-- Add a deck counter to show remaining cards -->
        <div class="card-count" id="deck-count" style="position: fixed; top: 10px; right: 10px; background-color: var(--secondary-color); color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; box-shadow: var(--card-shadow);">
            Deck: <span id="deck-count-value">0</span>
        </div>
        
        <div id="start-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Choose Your Strategy</h2>
            <div class="game-options">
                <button id="bat-first-btn">Bat First</button>
                <button id="bowl-first-btn">Bowl First</button>
            </div>
        </div>
        
        <div id="game-screen" class="hidden">
            <div class="game-options">
                <button id="reset-btn" class="reset-btn">Reset Game</button>
            </div>
            
            <div class="game-area">
                <div class="scoreboard">
                    <div class="score-section">
                        <h2>Your Score</h2>
                        <p class="score-detail">Runs: <span id="user-runs">0</span>/<span id="user-wickets">0</span></p>
                        <p class="score-detail">Overs: <span id="user-overs">0.0</span></p>
                        <p id="user-innings-indicator" class="current-innings hidden">Batting Now</p>
                    </div>
                    <div class="score-section">
                        <h2>Target</h2>
                        <p class="score-detail"><span id="target-runs">-</span></p>
                    </div>
                    <div class="score-section">
                        <h2>Computer Score</h2>
                        <p class="score-detail">Runs: <span id="comp-runs">0</span>/<span id="comp-wickets">0</span></p>
                        <p class="score-detail">Overs: <span id="comp-overs">0.0</span></p>
                        <p id="comp-innings-indicator" class="current-innings hidden">Batting Now</p>
                    </div>
                </div>
                
                <div class="match-stats">
                    <div class="stat-box">
                        <div class="stat-title">Over</div>
                        <div id="current-over" class="stat-value">0.0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">Ball</div>
                        <div id="ball-count" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">Required</div>
                        <div id="req-runs" class="stat-value">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">Run Rate</div>
                        <div id="run-rate" class="stat-value">0.00</div>
                    </div>
                </div>
                
                <div id="ball-result-display" class="hidden">
                    <div id="ball-result" class="ball-result">4 RUNS!</div>
                </div>
                
                <div class="board">
                    <div class="play-area">
                        <div class="card-played">
                            <div class="card-title">Bowler's Card</div>
                            <div id="bowler-card" class="card">
                                <div class="card-header">Select a card to start</div>
                                <img src="/api/placeholder/400/180" alt="Candidate Photo" class="player-image">
                                <div class="card-body">
                                    <div class="card-info">
                                        <span class="info-label">Party:</span>
                                        <span class="info-value party-tag">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Age:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Gender:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Vote Share:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Rank:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Constituency:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">State:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Type:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Turnout:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Margin:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Female Turnout Edge:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-played">
                            <div class="card-title">Batter's Card</div>
                            <div id="batter-card" class="card">
                                <div class="card-header">Select a card to start</div>
                                <img src="/api/placeholder/400/180" alt="Candidate Photo" class="player-image">
                                <div class="card-body">
                                    <div class="card-info">
                                        <span class="info-label">Party:</span>
                                        <span class="info-value party-tag">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Age:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Gender:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Vote Share:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Rank:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Constituency:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">State:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Type:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Turnout:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Margin:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="info-label">Female Turnout Edge:</span>
                                        <span class="info-value">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New outcome area for ball results -->
                    <div id="outcome-area" class="outcome-area hidden">
                        <div class="outcome-title">Ball Outcome</div>
                        <div id="outcome-message" class="outcome-message">4 RUNS!</div>
                        <button id="next-ball-btn" class="next-ball-btn">Next Ball</button>
                    </div>
                    
                    <div class="result-highlight" id="result-display"></div>
                    
                    <div class="action-area">
                        <div class="card-selection">
                            <div>
                                <h3 id="action-text" style="text-align: center; margin-bottom: 15px;">Please wait for the bowler's card</h3>
                                <div class="player-cards" id="player-cards"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="game-log">
                    <div class="log-title">Match Commentary</div>
                    <div id="log-entries"></div>
                </div>
            </div>
        </div>
        
        <div id="game-over-modal" class="game-over-modal">
            <div class="modal-content">
                <h2 class="modal-title">Game Over!</h2>
                <p id="modal-message" class="modal-message">The match has ended.</p>
                
                <!-- Added final scoreboard in the game over modal -->
                <div class="final-scoreboard">
                    <div class="final-score-title">Final Scorecard</div>
                    <div class="final-score-row">
                        <span class="final-score-label">Your Score:</span>
                        <span id="final-user-score">0/0 (0.0)</span>
                    </div>
                    <div class="final-score-row">
                        <span class="final-score-label">Computer Score:</span>
                        <span id="final-comp-score">0/0 (0.0)</span>
                    </div>
                    <div class="final-score-row">
                        <span class="final-score-label">Result:</span>
                        <span id="final-result">-</span>
                    </div>
                </div>
                
                <button id="play-again-btn" class="modal-button">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Game state variables
        let cards = [];
        let deck = [];
        let playerCards = [];
        let computerCards = [];
        let userIsBatting = false;
        let userIsBowling = false;
        let currentInnings = 1;
        let userRuns = 0;
        let userWickets = 0;
        let compRuns = 0;
        let compWickets = 0;
        let balls = 0;
        let target = null;
        let bowlerCardPlayed = null;
        let batterCardPlayed = null;
        let gameOver = false;
        let lastBallOutcome = null;
        let lastBallRuns = 0;
        let lastBallWicket = false;
        let waitingForNextBall = false;
        
        // Constants
        const TOTAL_OVERS = 6;
        const TOTAL_WICKETS = 6;
        const BALLS_PER_OVER = 6;
        
        // DOM elements
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const batFirstBtn = document.getElementById('bat-first-btn');
        const bowlFirstBtn = document.getElementById('bowl-first-btn');
        const resetBtn = document.getElementById('reset-btn');
        const userRunsDisplay = document.getElementById('user-runs');
        const userWicketsDisplay = document.getElementById('user-wickets');
        const userOversDisplay = document.getElementById('user-overs');
        const compRunsDisplay = document.getElementById('comp-runs');
        const compWicketsDisplay = document.getElementById('comp-wickets');
        const compOversDisplay = document.getElementById('comp-overs');
        const targetRunsDisplay = document.getElementById('target-runs');
        const reqRunsDisplay = document.getElementById('req-runs');
        const currentOverDisplay = document.getElementById('current-over');
        const ballCountDisplay = document.getElementById('ball-count');
        const runRateDisplay = document.getElementById('run-rate');
        const bowlerCardDisplay = document.getElementById('bowler-card');
        const batterCardDisplay = document.getElementById('batter-card');
        const playerCardsDisplay = document.getElementById('player-cards');
        const actionTextDisplay = document.getElementById('action-text');
        const logEntriesDisplay = document.getElementById('log-entries');
        const userInningsIndicator = document.getElementById('user-innings-indicator');
        const compInningsIndicator = document.getElementById('comp-innings-indicator');
        const gameOverModal = document.getElementById('game-over-modal');
        const modalMessage = document.getElementById('modal-message');
        const playAgainBtn = document.getElementById('play-again-btn');
        const resultDisplay = document.getElementById('result-display');
        const ballResultDisplay = document.getElementById('ball-result-display');
        const ballResult = document.getElementById('ball-result');
        const outcomeArea = document.getElementById('outcome-area');
        const outcomeMessage = document.getElementById('outcome-message');
        const nextBallBtn = document.getElementById('next-ball-btn');
        const finalUserScore = document.getElementById('final-user-score');
        const finalCompScore = document.getElementById('final-comp-score');
        const finalResult = document.getElementById('final-result');
        
        // Event listeners
        batFirstBtn.addEventListener('click', () => startGame(true));
        bowlFirstBtn.addEventListener('click', () => startGame(false));
        resetBtn.addEventListener('click', resetGame);
        playAgainBtn.addEventListener('click', resetGame);
        nextBallBtn.addEventListener('click', prepareNextBall);
        
        // Initialize the game
        async function initGame() {
            try {
                // Load cards from cards.json
                const response = await fetch('cards.json');
                const cardsData = await response.json();
                cards = Object.values(cardsData);
                console.log(`Loaded ${cards.length} cards`);
            } catch (error) {
                console.error('Error loading cards:', error);
                
                // For testing/demo purposes, create some sample cards
                cards = [];
                for (let i = 1; i <= 100; i++) {
                    cards.push({
                        id: i,
                        name: `Candidate ${i}`,
                        photo: `/api/placeholder/400/180?text=Candidate${i}`,
                        age: Math.floor(Math.random() * 40) + 30,
                        gender: Math.random() > 0.5 ? 'MALE' : 'FEMALE',
                        party: ['BJP', 'INC', 'AAP', 'YSRCP', 'DMK', 'TMC'][Math.floor(Math.random() * 6)],
                        vote_share: Math.floor(Math.random() * 50) + 20,
                        rank: Math.floor(Math.random() * 3) + 1,
                        constituency: `Constituency ${i}`,
                        state: ['Karnataka', 'Maharashtra', 'Tamil Nadu', 'Uttar Pradesh', 'West Bengal'][Math.floor(Math.random() * 5)],
                        type: ['GEN', 'SC', 'ST', 'OBC'][Math.floor(Math.random() * 4)],
                        turnout: Math.floor(Math.random() * 30) + 60,
                        margin: Math.floor(Math.random() * 25) + 1,
                        female_turnout_edge: parseFloat((Math.random() * 5 - 2.5).toFixed(2))
                    });
                }
            }
            
            // Once cards are loaded, initialize the deck count display
            updateDisplays();
        }
        
        // Start the game
        function startGame(userBatsFirst) {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // Set game mode
            userIsBatting = userBatsFirst;
            userIsBowling = !userBatsFirst;
            
            // Show current innings indicator
            if (userIsBatting) {
                userInningsIndicator.classList.remove('hidden');
                compInningsIndicator.classList.add('hidden');
            } else {
                userInningsIndicator.classList.add('hidden');
                compInningsIndicator.classList.remove('hidden');
            }
            
            // Shuffle deck and deal cards
            shuffleDeck();
            dealCards();
            
            // Set initial game state
            updateDisplays();
            
            // Set action text based on who's batting/bowling
            setActionText();
            
            // The bowler always plays first for each ball
            if (userIsBowling) {
                // If user is bowling first, wait for user to select a bowling card
                actionTextDisplay.textContent = 'Your turn to bowl! Select a card';
            } else {
                // If computer is bowling first, computer plays a bowling card
                computerPlaysBowlingCard();
            }
            
            // Log game start
            addLogEntry(`<span class="log-highlight">Game started!</span> ${userBatsFirst ? 'You' : 'Computer'} is batting first.`);
        }
        
        // Shuffle the deck of cards
        function shuffleDeck() {
            deck = [...cards];
            
            // Fisher-Yates shuffle algorithm
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }
        
        // Deal cards to players
        function dealCards() {
            playerCards = deck.splice(0, 6);
            computerCards = deck.splice(0, 6);
            renderPlayerCards();
        }
        
        // Render player's cards
        function renderPlayerCards() {
            playerCardsDisplay.innerHTML = '';
            
            playerCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'player-card';
                cardElement.dataset.index = index;
                
                cardElement.innerHTML = `
                    <div class="mini-card-header">${card.name}</div>
                    <img src="${card.photo}" alt="${card.name}" class="mini-player-image">
                    <div class="mini-card-body">
                        <div class="mini-card-info">
                            <span class="mini-info-label">Party:</span>
                            <span>${card.party}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Vote Share:</span>
                            <span>${card.vote_share}%</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Rank:</span>
                            <span>${card.rank}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Age:</span>
                            <span>${card.age}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Gender:</span>
                            <span>${card.gender}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Type:</span>
                            <span>${card.type}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Constituency:</span>
                            <span title="${card.constituency}">${card.constituency.length > 12 ? card.constituency.substring(0, 10) + '...' : card.constituency}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">State:</span>
                            <span title="${card.state}">${card.state.length > 12 ? card.state.substring(0, 10) + '...' : card.state}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Turnout:</span>
                            <span>${card.turnout}%</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Margin:</span>
                            <span>${card.margin}%</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Female Turnout Edge:</span>
                            <span>${card.female_turnout_edge}%</span>
                        </div>
                    </div>
                `;
                
                // Only enable card selection if not waiting for next ball
                if (!waitingForNextBall) {
                    cardElement.addEventListener('click', () => playerSelectsCard(index));
                }
                
                playerCardsDisplay.appendChild(cardElement);
            });
        }
        
        // Player selects a card
        function playerSelectsCard(index) {
            if (gameOver || (waitingForNextBall && !isCardRefreshTime)) return;
            
            // Check if we're in card refresh mode
            if (isCardRefreshTime) {
                discardAndDrawCard(index);
                return;
            }
            
            // If player is bowling and bowler card not played yet
            if (userIsBowling && !bowlerCardPlayed) {
                bowlerCardPlayed = playerCards[index];
                displayCard(bowlerCardPlayed, bowlerCardDisplay);
                
                // Remove the card from player's hand
                playerCards.splice(index, 1);
                
                // Draw a new card
                if (deck.length > 0) {
                    playerCards.push(deck.shift());
                }
                
                // Re-render player cards
                renderPlayerCards();
                
                // Computer plays batting card
                computerPlaysBattingCard();
                
                // Log
                addLogEntry(`You bowled with <span class="log-highlight">${bowlerCardPlayed.name}</span> (${bowlerCardPlayed.vote_share}% vote share).`);
            }
            
            // If player is batting and bowler card already played
            else if (userIsBatting && bowlerCardPlayed) {
                batterCardPlayed = playerCards[index];
                displayCard(batterCardPlayed, batterCardDisplay);
                
                // Remove the card from player's hand
                playerCards.splice(index, 1);
                
                // Draw a new card
                if (deck.length > 0) {
                    playerCards.push(deck.shift());
                }
                
                // Re-render player cards
                renderPlayerCards();
                
                // Process the ball
                processBall();
                
                // Log
                addLogEntry(`You batted with <span class="log-highlight">${batterCardPlayed.name}</span> (${batterCardPlayed.vote_share}% vote share).`);
            }
            
            // Update displays
            updateDisplays();
        }
        
        // Computer plays a bowling card
        function computerPlaysBowlingCard() {
            if (gameOver || waitingForNextBall) return;
            
            // Randomly select a card from computer's hand
            const randomIndex = Math.floor(Math.random() * computerCards.length);
            bowlerCardPlayed = computerCards[randomIndex];
            
            // Display the card
            displayCard(bowlerCardPlayed, bowlerCardDisplay);
            
            // Remove the card from computer's hand
            computerCards.splice(randomIndex, 1);
            
            // Draw a new card
            if (deck.length > 0) {
                computerCards.push(deck.shift());
            }
            
            // Update action text
            actionTextDisplay.textContent = "Your turn to bat! Select a card";
            
            // Log
            addLogEntry(`Computer bowled with <span class="log-highlight">${bowlerCardPlayed.name}</span> (${bowlerCardPlayed.vote_share}% vote share).`);
        }
        
        // Computer plays a batting card
        function computerPlaysBattingCard() {
            if (gameOver || waitingForNextBall) return;
            
            // Randomly select a card from computer's hand
            const randomIndex = Math.floor(Math.random() * computerCards.length);
            batterCardPlayed = computerCards[randomIndex];
            
            // Display the card
            displayCard(batterCardPlayed, batterCardDisplay);
            
            // Remove the card from computer's hand
            computerCards.splice(randomIndex, 1);
            
            // Draw a new card
            if (deck.length > 0) {
                computerCards.push(deck.shift());
            }
            
            // Process the ball
            processBall();
            
            // Log
            addLogEntry(`Computer batted with <span class="log-highlight">${batterCardPlayed.name}</span> (${batterCardPlayed.vote_share}% vote share).`);
        }
        
        // Display a card in the card display area
        function displayCard(card, displayElement) {
            displayElement.innerHTML = `
                <div class="card-header">${card.name}</div>
                <img src="${card.photo}" alt="${card.name}" class="player-image">
                <div class="card-body">
                    <div class="card-info">
                        <span class="info-label">Party:</span>
                        <span class="info-value party-tag">${card.party}</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Age:</span>
                        <span class="info-value">${card.age}</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Gender:</span>
                        <span class="info-value">${card.gender}</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Vote Share:</span>
                        <span class="info-value">${card.vote_share}%</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Rank:</span>
                        <span class="info-value">${card.rank}</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Constituency:</span>
                        <span class="info-value">${card.constituency}</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">State:</span>
                        <span class="info-value">${card.state}</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Type:</span>
                        <span class="info-value">${card.type}</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Turnout:</span>
                        <span class="info-value">${card.turnout}%</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Margin:</span>
                        <span class="info-value">${card.margin}%</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Female Turnout Edge:</span>
                        <span class="info-value">${card.female_turnout_edge}%</span>
                    </div>
                </div>
            `;
        }
        
        // Process the ball (determine outcome)
        function processBall() {
            balls++;
            let runsScored = 0;
            let isWicket = false;
            let outcomeDescription = "";
            
            // First check for wicket
            // Logic: If batter's vote_share < bowler's vote_share, it's a wicket
            // EXCEPTION: Rank 1 batters can never get out irrespective of vote_share
            if (batterCardPlayed.vote_share < bowlerCardPlayed.vote_share && batterCardPlayed.rank !== 1) {
                isWicket = true;
                outcomeDescription = `${batterCardPlayed.name}'s vote share (${batterCardPlayed.vote_share}%) is lower than ${bowlerCardPlayed.name}'s (${bowlerCardPlayed.vote_share}%).`;
            } else {
                // If no wicket, calculate runs based on the new rules
                
                // Special cases first:
                let specialCaseApplied = false;
                
                // 1. If both cards belong to the same party, compute 0 runs
                if (batterCardPlayed.party === bowlerCardPlayed.party) {
                    runsScored = 0;
                    outcomeDescription = `Both players belong to ${batterCardPlayed.party} party. No runs scored.`;
                    specialCaseApplied = true;
                }
                // 2. For FEMALE bowlers, non-FEMALE batters get 0 runs
                else if (bowlerCardPlayed.gender === "FEMALE" && batterCardPlayed.gender !== "FEMALE") {
                    runsScored = 0;
                    outcomeDescription = `${bowlerCardPlayed.name} (FEMALE) bowled to ${batterCardPlayed.name} (${batterCardPlayed.gender}). Gender advantage - no runs scored.`;
                    specialCaseApplied = true;
                }
                // 3. For SC bowlers, non-SC batters get 0 runs
                else if (bowlerCardPlayed.type === "SC" && batterCardPlayed.type !== "SC") {
                    runsScored = 0;
                    outcomeDescription = `${bowlerCardPlayed.name} (SC) bowled to ${batterCardPlayed.name} (${batterCardPlayed.type}). Caste advantage - no runs scored.`;
                    specialCaseApplied = true;
                }
                // 4. For ST bowlers, non-ST batters get 0 runs
                else if (bowlerCardPlayed.type === "ST" && batterCardPlayed.type !== "ST") {
                    runsScored = 0;
                    outcomeDescription = `${bowlerCardPlayed.name} (ST) bowled to ${batterCardPlayed.name} (${batterCardPlayed.type}). Tribal advantage - no runs scored.`;
                    specialCaseApplied = true;
                }
                // Otherwise, calculate runs based on the vote_share difference
                else {
                    // Calculate the difference
                    const difference = batterCardPlayed.vote_share - bowlerCardPlayed.vote_share;
                    
                    // Assign runs based on the difference ranges
                    if (difference >= 0 && difference < 3) {
                        runsScored = 0;
                        outcomeDescription = `Vote share difference (${difference.toFixed(1)}%) is below 3%. No runs scored.`;
                    } else if (difference >= 3 && difference < 6) {
                        runsScored = 1;
                        outcomeDescription = `Vote share difference (${difference.toFixed(1)}%) is between 3-6%. 1 run scored.`;
                    } else if (difference >= 6 && difference < 9) {
                        runsScored = 2;
                        outcomeDescription = `Vote share difference (${difference.toFixed(1)}%) is between 6-9%. 2 runs scored.`;
                    } else if (difference >= 9 && difference < 12) {
                        runsScored = 3;
                        outcomeDescription = `Vote share difference (${difference.toFixed(1)}%) is between 9-12%. 3 runs scored.`;
                    } else if (difference >= 12 && difference < 15) {
                        runsScored = 4;
                        outcomeDescription = `Vote share difference (${difference.toFixed(1)}%) is between 12-15%. 4 runs scored.`;
                    } else if (difference >= 15) {
                        runsScored = 6;
                        outcomeDescription = `Vote share difference (${difference.toFixed(1)}%) is 15% or more. 6 runs scored!`;
                    }
                }
                
                // Check if Rank 1 batter would have been out but was saved
                if (batterCardPlayed.rank === 1 && batterCardPlayed.vote_share < bowlerCardPlayed.vote_share) {
                    outcomeDescription = `${batterCardPlayed.name} is a Rank 1 candidate and can't be dismissed despite lower vote share! ` + outcomeDescription;
                }
            }
            
            // Store the outcome for next ball button
            lastBallOutcome = isWicket ? "WICKET!" : `${runsScored} RUN${runsScored !== 1 ? 'S' : ''}!`;
            lastBallRuns = runsScored;
            lastBallWicket = isWicket;
            
            // Set waiting for next ball
            waitingForNextBall = true;
            
            // Update scores
            if (userIsBatting) {
                if (isWicket) {
                    userWickets++;
                } else {
                    userRuns += runsScored;
                }
            } else {
                if (isWicket) {
                    compWickets++;
                } else {
                    compRuns += runsScored;
                }
            }
            
            // Show outcome area with detailed explanation
            outcomeMessage.innerHTML = `
                <div class="refresh-info">${lastBallOutcome}</div>
                <p>${outcomeDescription}</p>
                <p>${isWicket ? (userIsBatting ? 'You' : 'Computer') + ' lost a wicket!' : 
                   (runsScored === 0 ? 'Dot ball!' : (userIsBatting ? 'You' : 'Computer') + ' scored ' + runsScored + ' run' + (runsScored !== 1 ? 's' : '') + '!')}</p>
            `;
            outcomeArea.classList.remove('hidden');
            
            // Log the result with more details
            if (isWicket) {
                addLogEntry(`<span class="log-highlight">WICKET!</span> ${userIsBatting ? 'You' : 'Computer'} lost a wicket. ${outcomeDescription}`);
            } else {
                addLogEntry(`<span class="log-highlight">${runsScored} run${runsScored !== 1 ? 's' : ''}</span> scored by ${userIsBatting ? 'you' : 'computer'}. ${outcomeDescription}`);
            }
            
            // Update displays
            updateDisplays();
            
            // Check if over is complete
            if (balls % BALLS_PER_OVER === 0) {
                const currentOver = Math.floor(balls / BALLS_PER_OVER);
                addLogEntry(`<span class="log-highlight">End of over ${currentOver}</span>`);
                
                // At the end of each but the last over, bowler can refresh cards
                if (currentOver < TOTAL_OVERS - 1) {
                    // Determine who is bowling in the current innings
                    const userIsBowlingNow = (userIsBatting === false);
                    
                    // After showing outcome, we'll show the card refresh option
                    outcomeMessage.innerHTML += `
                        <p style="margin-top: 15px;"><strong>End of over ${currentOver}.</strong></p>
                        <p>${userIsBowlingNow ? 'You' : 'Computer'} can refresh cards twice.</p>
                    `;
                    
                    // Change next ball button text
                    nextBallBtn.textContent = "Manage Cards";
                }
            }
            
            // Check if innings/game is over (but don't proceed automatically)
            checkInningsStatus();
        }
        
        // Variable to track card refresh opportunities for the bowler
        let cardRefreshCount = 0;
        let isCardRefreshTime = false;
        
        // Prepare for the next ball
        function prepareNextBall() {
            if (gameOver) return;
            
            // Check if it's card refresh time (end of over but not last over)
            const currentOver = Math.floor(balls / BALLS_PER_OVER);
            
            // If we just finished an over (but not the last one) and we haven't used all refresh opportunities
            if (balls % BALLS_PER_OVER === 0 && currentOver < TOTAL_OVERS - 1 && cardRefreshCount < 2) {
                // If button text is "Manage Cards" or we're already in refresh mode
                if (nextBallBtn.textContent === "Manage Cards" || isCardRefreshTime) {
                    isCardRefreshTime = true;
                    
                    // Determine who is bowling in the current innings
                    const userIsBowlingNow = (userIsBatting === false);
                    
                    if (userIsBowlingNow) {
                        // User is bowling, show card refresh interface
                        showCardRefreshInterface();
                        return;
                    } else {
                        // Computer is bowling, it will automatically refresh cards
                        computerRefreshCards();
                        cardRefreshCount++;
                        
                        if (cardRefreshCount < 2) {
                            // Still has one more refresh
                            outcomeMessage.innerHTML = `
                                <div class="refresh-info">Computer's Card Refresh (${cardRefreshCount}/2)</div>
                                <p>Computer has refreshed one card.</p>
                                <p>Click Continue to see next refresh.</p>
                            `;
                            nextBallBtn.textContent = "Continue";
                            return;
                        } else {
                            // Used all refreshes, proceed to next over
                            outcomeMessage.innerHTML = `
                                <div class="refresh-info">Computer's Card Refresh Complete</div>
                                <p>Computer has refreshed cards twice.</p>
                                <p>Ready for the next over!</p>
                            `;
                            nextBallBtn.textContent = "Start Next Over";
                            cardRefreshCount = 0;
                            isCardRefreshTime = false;
                            return;
                        }
                    }
                } else if (nextBallBtn.textContent === "Continue") {
                    // Second computer refresh
                    computerRefreshCards();
                    cardRefreshCount = 0;
                    isCardRefreshTime = false;
                    outcomeMessage.innerHTML = `
                        <div class="refresh-info">Computer's Card Refresh Complete</div>
                        <p>Computer has refreshed cards twice.</p>
                        <p>Ready for the next over!</p>
                    `;
                    nextBallBtn.textContent = "Start Next Over";
                    return;
                } else if (nextBallBtn.textContent === "Start Next Over") {
                    // Reset card refresh state
                    cardRefreshCount = 0;
                    isCardRefreshTime = false;
                }
            }
            
            // Handle innings change when button says "Start Second Innings"
            if (nextBallBtn.textContent === "Start Second Innings") {
                // For a clean transition between innings, explicitly set up the second innings
                
                // Reset cards for next ball
                bowlerCardPlayed = null;
                batterCardPlayed = null;
                
                // Reset waiting state
                waitingForNextBall = false;
                
                // Hide outcome area after acknowledging the innings change
                outcomeArea.classList.add('hidden');
                
                // Reset button text
                nextBallBtn.textContent = "Next Ball";
                
                // Reset card displays
                resetCardDisplays();
                
                // The bowler always plays first for the first ball of the new innings
                if ((userIsBatting && !userIsBowling) || (!userIsBatting && !userIsBowling)) {
                    // Computer is bowling in second innings
                    computerPlaysBowlingCard();
                } else {
                    // User is bowling in second innings
                    setActionText();
                }
                
                // Update player cards to make them clickable again
                renderPlayerCards();
                
                // Update displays for second innings
                updateDisplays();
                
                return;
            }
            
            // Regular next ball logic
            // Hide outcome area
            outcomeArea.classList.add('hidden');
            
            // Reset cards for next ball
            bowlerCardPlayed = null;
            batterCardPlayed = null;
            
            // Reset waiting state
            waitingForNextBall = false;
            
            // Reset button text
            nextBallBtn.textContent = "Next Ball";
            
            // Reset card displays
            resetCardDisplays();
            
            // The bowler always plays first for the next ball
            if ((userIsBatting && !userIsBowling) || (!userIsBatting && !userIsBowling)) {
                // Computer is bowling
                computerPlaysBowlingCard();
            } else {
                // User is bowling
                setActionText();
            }
            
            // Update player cards to make them clickable again
            renderPlayerCards();
        }
        
        // Show interface for user to refresh cards
        function showCardRefreshInterface() {
            // Display card refresh interface
            outcomeMessage.innerHTML = `<div class="refresh-info">Card Refresh (${cardRefreshCount + 1}/2)</div>
                                        Select a card to discard and draw a new one`;
            
            // Display player cards with discard option
            playerCardsDisplay.innerHTML = '';
            
            playerCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'player-card card-refresh-highlight';
                cardElement.dataset.index = index;
                
                cardElement.innerHTML = `
                    <div class="mini-card-header">${card.name}</div>
                    <img src="${card.photo}" alt="${card.name}" class="mini-player-image">
                    <div class="mini-card-body">
                        <div class="mini-card-info">
                            <span class="mini-info-label">Party:</span>
                            <span>${card.party}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Vote Share:</span>
                            <span>${card.vote_share}%</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Rank:</span>
                            <span>${card.rank}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Gender:</span>
                            <span>${card.gender}</span>
                        </div>
                        <div class="mini-card-info">
                            <span class="mini-info-label">Type:</span>
                            <span>${card.type}</span>
                        </div>
                        <button class="discard-btn">Discard</button>
                    </div>
                `;
                
                // Add click handler for card discard
                cardElement.addEventListener('click', () => discardAndDrawCard(index));
                
                playerCardsDisplay.appendChild(cardElement);
            });
            
            // Update action text
            actionTextDisplay.textContent = `Select a card to discard (${cardRefreshCount + 1}/2)`;
        }
        
        // User discards a card and draws a new one
        function discardAndDrawCard(index) {
            // Get the discarded card info for the log
            const discardedCard = playerCards[index];
            
            // Remove the card from player's hand
            playerCards.splice(index, 1);
            
            // Draw a new card
            let newCard = null;
            if (deck.length > 0) {
                newCard = deck.shift();
                playerCards.push(newCard);
                addLogEntry(`You discarded <span class="log-highlight">${discardedCard.name}</span> (${discardedCard.vote_share}% vote share) and drew a new card.`);
            } else {
                addLogEntry(`You discarded <span class="log-highlight">${discardedCard.name}</span>, but the deck is empty!`);
            }
            
            // Increment refresh count
            cardRefreshCount++;
            
            // Check if user has used all refreshes
            if (cardRefreshCount < 2) {
                // Still has one more refresh
                outcomeMessage.innerHTML = `
                    <div class="refresh-info">Card Refresh (${cardRefreshCount}/2)</div>
                    <p>You discarded <strong>${discardedCard.name}</strong>.</p>
                    ${newCard ? `<p>You drew <strong>${newCard.name}</strong> (${newCard.party}, ${newCard.vote_share}% vote share).</p>` : ''}
                    <p>You can discard one more card.</p>
                `;
                showCardRefreshInterface();
            } else {
                // Used all refreshes, proceed to next ball
                outcomeMessage.innerHTML = `
                    <div class="refresh-info">Card Refresh Complete</div>
                    <p>You discarded <strong>${discardedCard.name}</strong>.</p>
                    ${newCard ? `<p>You drew <strong>${newCard.name}</strong> (${newCard.party}, ${newCard.vote_share}% vote share).</p>` : ''}
                    <p>You have refreshed cards twice. Ready for next over!</p>
                `;
                nextBallBtn.textContent = "Start Next Over";
                cardRefreshCount = 0;
                isCardRefreshTime = false;
                
                // Re-render player cards
                renderPlayerCards();
            }
            
            // Update displays
            updateDisplays();
        }
        
        // Computer automatically refreshes cards
        function computerRefreshCards() {
            // Find the card with the lowest vote_share to discard
            let lowestIndex = 0;
            let lowestVoteShare = computerCards[0].vote_share;
            
            for (let i = 1; i < computerCards.length; i++) {
                if (computerCards[i].vote_share < lowestVoteShare) {
                    lowestVoteShare = computerCards[i].vote_share;
                    lowestIndex = i;
                }
            }
            
            // Get the card info for the log
            const discardedCard = computerCards[lowestIndex];
            
            // Remove the card with lowest vote_share
            computerCards.splice(lowestIndex, 1);
            
            // Draw a new card
            let newCard = null;
            if (deck.length > 0) {
                newCard = deck.shift();
                computerCards.push(newCard);
                addLogEntry(`Computer discarded <span class="log-highlight">${discardedCard.name}</span> (${discardedCard.vote_share}% vote share) and drew a new card.`);
            } else {
                addLogEntry(`Computer discarded <span class="log-highlight">${discardedCard.name}</span>, but the deck is empty!`);
            }
            
            // Update displays
            updateDisplays();
        }
        
        // Check if innings or game is over
        function checkInningsStatus() {
            const oversCompleted = Math.floor(balls / BALLS_PER_OVER);
            const currentWickets = userIsBatting ? userWickets : compWickets;
            
            // Check if innings is over
            const inningsOver = oversCompleted >= TOTAL_OVERS || currentWickets >= TOTAL_WICKETS;
            
            // Check if target has been achieved in second innings
            let targetAchieved = false;
            if (currentInnings === 2) {
                const currentRuns = userIsBatting ? userRuns : compRuns;
                targetAchieved = currentRuns >= target;
            }
            
            // If innings is over or target achieved
            if (inningsOver || targetAchieved) {
                // If first innings is over
                if (currentInnings === 1 && !targetAchieved) {
                    currentInnings = 2;
                    
                    // Set target for second innings
                    if (userIsBatting) {
                        target = userRuns + 1;
                        
                        // Message for transition to player bowling
                        addLogEntry(`<span class="log-highlight">First innings over!</span> Computer needs ${target} runs to win.`);
                        
                        const inningsMessage = `
                            <div class="refresh-info">Innings Complete</div>
                            <p>Your batting innings is over! You scored ${userRuns}/${userWickets} in ${oversCompleted}.${balls % BALLS_PER_OVER} overs.</p>
                            <p>Now you'll be bowling. Computer needs ${target} runs to win.</p>
                        `;
                        outcomeMessage.innerHTML = inningsMessage;
                    } else {
                        target = compRuns + 1;
                        
                        // Message for transition to player batting
                        addLogEntry(`<span class="log-highlight">First innings over!</span> You need ${target} runs to win.`);
                        
                        const inningsMessage = `
                            <div class="refresh-info">Innings Complete</div>
                            <p>Computer's batting innings is over! They scored ${compRuns}/${compWickets} in ${oversCompleted}.${balls % BALLS_PER_OVER} overs.</p>
                            <p>Now you'll be batting. You need ${target} runs to win.</p>
                        `;
                        outcomeMessage.innerHTML = inningsMessage;
                    }
                    
                    // After first innings, switch roles and prepare for second innings
                    // Reset roles for second innings
                    const wasUserBatting = userIsBatting;
                    userIsBatting = !wasUserBatting;
                    userIsBowling = wasUserBatting;
                    
                    // Update innings indicators
                    if (userIsBatting) {
                        userInningsIndicator.classList.remove('hidden');
                        compInningsIndicator.classList.add('hidden');
                    } else {
                        userInningsIndicator.classList.add('hidden');
                        compInningsIndicator.classList.remove('hidden');
                    }
                    
                    // Reset balls count for new innings
                    balls = 0;
                    
                    // Reset card refresh variables
                    cardRefreshCount = 0;
                    isCardRefreshTime = false;
                    
                    // Change next ball button text
                    nextBallBtn.textContent = "Start Second Innings";
                    
                    // Update displays
                    updateDisplays();
                } else {
                    // Game is over - show the final result
                    endGame();
                }
            }
        }
        
        // End the game
        function endGame() {
            gameOver = true;
            
            // Determine the winner
            let winner = '';
            let winMessage = '';
            let winReason = '';
            
            if (currentInnings === 2) {
                const userBattedSecond = userIsBatting;
                const compBattedSecond = !userIsBatting;
                
                if ((userBattedSecond && userRuns >= target) || (compBattedSecond && compRuns < target)) {
                    winner = 'You';
                    const remainingWickets = TOTAL_WICKETS - userWickets;
                    const remainingBalls = (TOTAL_OVERS * BALLS_PER_OVER) - balls;
                    
                    if (userBattedSecond) {
                        winMessage = `You won by ${remainingWickets} wicket${remainingWickets !== 1 ? 's' : ''}!`;
                        winReason = `You successfully chased down the target of ${target} runs with ${remainingWickets} wicket${remainingWickets !== 1 ? 's' : ''} and ${remainingBalls} ball${remainingBalls !== 1 ? 's' : ''} remaining.`;
                    } else {
                        winMessage = `You won by ${target - compRuns - 1} runs!`;
                        winReason = `You successfully defended your total of ${userRuns} runs, restricting the computer to ${compRuns}/${compWickets} in ${Math.floor(balls / BALLS_PER_OVER)}.${balls % BALLS_PER_OVER} overs.`;
                    }
                } else if ((compBattedSecond && compRuns >= target) || (userBattedSecond && userRuns < target)) {
                    winner = 'Computer';
                    const remainingWickets = TOTAL_WICKETS - compWickets;
                    const remainingBalls = (TOTAL_OVERS * BALLS_PER_OVER) - balls;
                    
                    if (compBattedSecond) {
                        winMessage = `Computer won by ${remainingWickets} wicket${remainingWickets !== 1 ? 's' : ''}!`;
                        winReason = `Computer successfully chased down the target of ${target} runs with ${remainingWickets} wicket${remainingWickets !== 1 ? 's' : ''} and ${remainingBalls} ball${remainingBalls !== 1 ? 's' : ''} remaining.`;
                    } else {
                        winMessage = `Computer won by ${target - userRuns - 1} runs!`;
                        winReason = `Computer successfully defended its total of ${compRuns} runs, restricting you to ${userRuns}/${userWickets} in ${Math.floor(balls / BALLS_PER_OVER)}.${balls % BALLS_PER_OVER} overs.`;
                    }
                } else {
                    // This shouldn't happen with the current logic, but just in case
                    winner = 'Nobody';
                    winMessage = 'The game ended in a tie!';
                    winReason = 'Both teams scored exactly the same number of runs.';
                }
            } else {
                // If game ended after first innings (shouldn't happen with current logic)
                if (userRuns > compRuns) {
                    winner = 'You';
                    winMessage = `You won by ${userRuns - compRuns} runs!`;
                    winReason = 'Game ended after the first innings.';
                } else if (compRuns > userRuns) {
                    winner = 'Computer';
                    winMessage = `Computer won by ${compRuns - userRuns} runs!`;
                    winReason = 'Game ended after the first innings.';
                } else {
                    winner = 'Nobody';
                    winMessage = 'The game ended in a tie!';
                    winReason = 'Both teams scored exactly the same number of runs.';
                }
            }
            
            // Hide the outcome area
            outcomeArea.classList.add('hidden');
            
            // Show winner in result display
            resultDisplay.textContent = `${winner} won the match!`;
            
            // Set final scorecard in the modal
            const userOversPlayed = `${Math.floor((userIsBatting ? balls : 0) / BALLS_PER_OVER)}.${(userIsBatting ? balls : 0) % BALLS_PER_OVER}`;
            const compOversPlayed = `${Math.floor((!userIsBatting ? balls : 0) / BALLS_PER_OVER)}.${(!userIsBatting ? balls : 0) % BALLS_PER_OVER}`;
            
            // Calculate complete innings information
            const userInningsComplete = userIsBatting ? false : (currentInnings === 2);
            const compInningsComplete = !userIsBatting ? false : (currentInnings === 2);
            
            const userOvers = userInningsComplete ? `${TOTAL_OVERS}.0` : userOversPlayed;
            const compOvers = compInningsComplete ? `${TOTAL_OVERS}.0` : compOversPlayed;
            
            finalUserScore.textContent = `${userRuns}/${userWickets} (${userOvers})`;
            finalCompScore.textContent = `${compRuns}/${compWickets} (${compOvers})`;
            finalResult.textContent = winMessage;
            
            // Show modal with game result
            modalMessage.innerHTML = `
                <p>${winMessage}</p>
                <p>${winReason}</p>
            `;
            gameOverModal.style.display = 'flex';
            
            // Log the result
            addLogEntry(`<span class="log-highlight">GAME OVER!</span> ${winMessage} ${winReason}`);
        }
        
        // Reset card displays
        function resetCardDisplays() {
            bowlerCardDisplay.innerHTML = `
                <div class="card-header">Select a card to start</div>
                <img src="/api/placeholder/400/180" alt="Candidate Photo" class="player-image">
                <div class="card-body">
                    <div class="card-info">
                        <span class="info-label">Party:</span>
                        <span class="info-value party-tag">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Age:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Gender:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Vote Share:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Rank:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Constituency:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">State:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Type:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Turnout:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Margin:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Female Turnout Edge:</span>
                        <span class="info-value">-</span>
                    </div>
                </div>
            `;
            
            batterCardDisplay.innerHTML = `
                <div class="card-header">Select a card to start</div>
                <img src="/api/placeholder/400/180" alt="Candidate Photo" class="player-image">
                <div class="card-body">
                    <div class="card-info">
                        <span class="info-label">Party:</span>
                        <span class="info-value party-tag">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Age:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Gender:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Vote Share:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Rank:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Constituency:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">State:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Type:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Turnout:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Margin:</span>
                        <span class="info-value">-</span>
                    </div>
                    <div class="card-info">
                        <span class="info-label">Female Turnout Edge:</span>
                        <span class="info-value">-</span>
                    </div>
                </div>
            `;
        }
        
        // Set action text based on current game state
        function setActionText() {
            if (isCardRefreshTime) {
                actionTextDisplay.textContent = `Select a card to discard (${cardRefreshCount + 1}/2)`;
            } else if (waitingForNextBall) {
                actionTextDisplay.textContent = 'Click "Next Ball" to continue';
            } else if (userIsBowling && !bowlerCardPlayed) {
                actionTextDisplay.textContent = 'Your turn to bowl! Select a card';
            } else if (userIsBatting && bowlerCardPlayed) {
                actionTextDisplay.textContent = 'Your turn to bat! Select a card';
            } else if (userIsBatting && !bowlerCardPlayed) {
                actionTextDisplay.textContent = 'Please wait for the computer to bowl';
            } else if (userIsBowling && bowlerCardPlayed) {
                actionTextDisplay.textContent = 'Please wait for the computer to bat';
            }
        }
        
        // Add an entry to the game log
        function addLogEntry(text) {
            const entryElement = document.createElement('div');
            entryElement.className = 'log-entry';
            entryElement.innerHTML = text;
            
            logEntriesDisplay.prepend(entryElement);
        }
        
        // Update all displays with current game state
        function updateDisplays() {
            userRunsDisplay.textContent = userRuns;
            userWicketsDisplay.textContent = userWickets;
            compRunsDisplay.textContent = compRuns;
            compWicketsDisplay.textContent = compWickets;
            
            // Calculate overs (e.g. 2.3 means 2 overs and 3 balls)
            const totalBalls = balls;
            const userBalls = userIsBatting ? totalBalls : (currentInnings === 2 ? totalBalls : 0);
            const compBalls = !userIsBatting ? totalBalls : (currentInnings === 2 ? totalBalls : 0);
            
            const userOvers = `${Math.floor(userBalls / BALLS_PER_OVER)}.${userBalls % BALLS_PER_OVER}`;
            const compOvers = `${Math.floor(compBalls / BALLS_PER_OVER)}.${compBalls % BALLS_PER_OVER}`;
            
            userOversDisplay.textContent = userOvers;
            compOversDisplay.textContent = compOvers;
            
            // Update current over and ball display for current innings
            const currentOver = `${Math.floor(totalBalls / BALLS_PER_OVER)}.${totalBalls % BALLS_PER_OVER}`;
            currentOverDisplay.textContent = currentOver;
            ballCountDisplay.textContent = totalBalls;
            
            // Update deck count
            const deckCountValue = document.getElementById('deck-count-value');
            if (deckCountValue) {
                deckCountValue.textContent = deck.length;
            }
            
            // Update target and required runs if available
            if (target) {
                targetRunsDisplay.textContent = target;
                
                const currentRuns = userIsBatting ? userRuns : compRuns;
                const requiredRuns = Math.max(0, target - currentRuns);
                
                reqRunsDisplay.textContent = requiredRuns;
                
                // If game is in second innings, add info about required runs
                if (currentInnings === 2) {
                    const remainingBalls = (TOTAL_OVERS * BALLS_PER_OVER) - totalBalls;
                    const remainingWickets = TOTAL_WICKETS - (userIsBatting ? userWickets : compWickets);
                    
                    if (requiredRuns > 0) {
                        resultDisplay.textContent = `${userIsBatting ? 'You need' : 'Computer needs'} ${requiredRuns} runs from ${remainingBalls} balls with ${remainingWickets} wickets remaining`;
                    } else {
                        resultDisplay.textContent = '';
                    }
                } else {
                    resultDisplay.textContent = '';
                }
            } else {
                targetRunsDisplay.textContent = '-';
                reqRunsDisplay.textContent = '-';
                resultDisplay.textContent = '';
            }
            
            // Calculate and update run rate
            if (totalBalls > 0) {
                const currentRuns = userIsBatting ? userRuns : compRuns;
                const runRate = (currentRuns / totalBalls) * 6;
                runRateDisplay.textContent = runRate.toFixed(2);
            } else {
                runRateDisplay.textContent = '0.00';
            }
            
            // Update action text based on waiting state
            setActionText();
        }
        
        // Reset the game to initial state
        function resetGame() {
            // Reset game state variables
            userIsBatting = false;
            userIsBowling = false;
            currentInnings = 1;
            userRuns = 0;
            userWickets = 0;
            compRuns = 0;
            compWickets = 0;
            balls = 0;
            target = null;
            bowlerCardPlayed = null;
            batterCardPlayed = null;
            gameOver = false;
            waitingForNextBall = false;
            cardRefreshCount = 0;
            isCardRefreshTime = false;
            
            // Reset displays
            resetCardDisplays();
            resultDisplay.textContent = '';
            outcomeArea.classList.add('hidden');
            nextBallBtn.textContent = "Next Ball";
            
            // Clear log
            logEntriesDisplay.innerHTML = '';
            
            // Hide game screen and modal
            gameScreen.classList.add('hidden');
            gameOverModal.style.display = 'none';
            
            // Show start screen
            startScreen.classList.remove('hidden');
            
            // Reset innings indicators
            userInningsIndicator.classList.add('hidden');
            compInningsIndicator.classList.add('hidden');
            
            // Re-shuffle the deck
            shuffleDeck();
            
            // Update the display
            updateDisplays();
        }
        
        // Initialize the game when page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
